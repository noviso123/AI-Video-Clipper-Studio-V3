<!DOCTYPE html>
<html lang="pt-BR">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>üéôÔ∏è Teste de Voz - AI Video Clipper</title>
        <style>
            * {
                font-family: 'Segoe UI', system-ui, sans-serif;
                box-sizing: border-box;
            }

            body {
                background: linear-gradient(135deg, #0a0a1a 0%, #1a1030 50%, #0a0a1a 100%);
                min-height: 100vh;
                margin: 0;
                padding: 20px;
                color: white;
            }

            .container {
                max-width: 700px;
                margin: 0 auto;
            }

            h1 {
                text-align: center;
                background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
                -webkit-background-clip: text;
                background-clip: text;
                -webkit-text-fill-color: transparent;
                font-size: 2rem;
                margin-bottom: 10px;
            }

            .subtitle {
                text-align: center;
                color: #94a3b8;
                margin-bottom: 30px;
            }

            .card {
                background: rgba(20, 20, 40, 0.8);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 20px;
            }

            .card h2 {
                margin-top: 0;
                color: #a78bfa;
                font-size: 1.2rem;
            }

            textarea {
                width: 100%;
                min-height: 150px;
                background: #1a1a2e;
                border: 2px solid #3b4785;
                border-radius: 12px;
                padding: 16px;
                font-size: 1.1rem;
                color: white;
                resize: vertical;
                transition: border-color 0.3s;
            }

            textarea:focus {
                outline: none;
                border-color: #8b5cf6;
            }

            textarea::placeholder {
                color: #64748b;
            }

            .btn {
                padding: 14px 28px;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-primary {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                color: white;
                width: 100%;
                justify-content: center;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .status {
                text-align: center;
                padding: 12px;
                border-radius: 8px;
                margin: 15px 0;
                display: none;
            }

            .status.loading {
                display: block;
                background: rgba(59, 130, 246, 0.2);
                color: #60a5fa;
            }

            .status.success {
                display: block;
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
            }

            .status.error {
                display: block;
                background: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

            .audio-player {
                width: 100%;
                margin-top: 15px;
                display: none;
            }

            .audio-player.visible {
                display: block;
            }

            audio {
                width: 100%;
                border-radius: 12px;
            }

            .voice-status {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 16px;
                background: rgba(16, 185, 129, 0.1);
                border-radius: 10px;
                margin-bottom: 20px;
            }

            .voice-status .dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #10b981;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }
            }

            .char-count {
                text-align: right;
                font-size: 0.85rem;
                color: #64748b;
                margin-top: 8px;
            }

            .examples {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 15px;
            }

            .example-btn {
                background: #1e293b;
                border: 1px solid #334155;
                color: #94a3b8;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 0.85rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .example-btn:hover {
                background: #334155;
                color: white;
            }

            .history {
                margin-top: 20px;
            }

            .history-item {
                background: #1e1e3a;
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .history-item .text {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-right: 12px;
                color: #94a3b8;
            }

            .history-item audio {
                width: 200px;
            }

            a {
                color: #60a5fa;
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            .spin {
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>üéôÔ∏è Teste de Voz Personalizada</h1>
            <p class="subtitle">Digite qualquer texto e ou√ßa com sua voz!</p>

            <!-- Voice Status -->
            <div class="voice-status" id="voiceStatus">
                <div class="dot"></div>
                <span>Voz personalizada ativa</span>
            </div>

            <!-- Input Card -->
            <div class="card">
                <h2>‚úçÔ∏è Digite seu texto</h2>
                <textarea id="textInput" placeholder="Digite aqui o que voc√™ quer ouvir com sua voz..."
                    maxlength="500">Ol√°! Esta √© uma demonstra√ß√£o da minha voz personalizada criada com intelig√™ncia artificial.</textarea>
                <div class="char-count"><span id="charCount">0</span>/500 caracteres</div>

                <!-- Console/Logs (New) -->
                <div class="card" id="consoleCard" style="margin-top: 15px; border: 1px solid #334155;">
                    <h3 style="margin: 0 0 10px; font-size: 1rem; color: #a78bfa;">üñ•Ô∏è Console de Processamento</h3>
                    <div class="script-box" id="consoleOutput"
                        style="height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; background: #000; padding: 10px; border-radius: 8px;">
                        <span style="color: #4ade80;">> Sistema pronto...</span>
                    </div>
                </div>

                <!-- Examples -->
                <div class="examples">
                    <button class="example-btn" onclick="setExample(1)">üì∫ Intro YouTube</button>
                    <button class="example-btn" onclick="setExample(2)">üî• Hook Viral</button>
                    <button class="example-btn" onclick="setExample(3)">üëã Despedida</button>
                    <button class="example-btn" onclick="setExample(4)">üí° Dica</button>
                </div>

                <!-- Generate Button -->
                <button class="btn btn-primary" id="generateBtn" onclick="generateVoice()" style="margin-top: 20px;">
                    <span id="btnIcon">üé§</span>
                    <span id="btnText">Gerar √Åudio</span>
                </button>

                <!-- Status -->
                <div class="status" id="status"></div>

                <!-- Audio Player -->
                <div class="audio-player" id="audioPlayer">
                    <h3 style="margin: 20px 0 10px; color: #10b981;">üîä Resultado:</h3>
                    <audio id="audioOutput" controls></audio>
                </div>
            </div>

            <!-- History -->
            <div class="card">
                <h2>üìú Hist√≥rico</h2>
                <div class="history" id="history">
                    <p style="color: #64748b; text-align: center;">Nenhum √°udio gerado ainda</p>
                </div>
            </div>

            <!-- Back Link -->
            <p style="text-align: center; margin-top: 30px;">
                <a href="/">‚Üê Voltar para o AI Video Clipper</a>
                &nbsp;|&nbsp;
                <a href="/voice-recorder">üéôÔ∏è Gravar Nova Voz</a>
            </p>
        </div>

        <script>
            const examples = {
                1: "E a√≠ pessoal! Sejam muito bem-vindos a mais um v√≠deo aqui do canal. Hoje vamos falar sobre um assunto muito importante!",
                2: "Voc√™ n√£o vai acreditar no que eu descobri! Isso vai mudar completamente a forma como voc√™ trabalha.",
                3: "Se voc√™ gostou desse conte√∫do, deixa aquele like maroto, se inscreve no canal e ativa o sininho para n√£o perder nada!",
                4: "Uma dica r√°pida que vai economizar muito do seu tempo: sempre organize suas tarefas por prioridade!"
            };

            const history = [];

            // Update char count
            const textInput = document.getElementById( 'textInput' );
            const charCount = document.getElementById( 'charCount' );

            textInput.addEventListener( 'input', () =>
            {
                charCount.textContent = textInput.value.length;
            } );
            charCount.textContent = textInput.value.length;

            function setExample ( num )
            {
                textInput.value = examples[ num ];
                charCount.textContent = textInput.value.length;
            }

            async function generateVoice ()
            {
                const text = textInput.value.trim();
                if ( !text )
                {
                    showStatus( 'error', 'Digite um texto primeiro!' );
                    return;
                }

                const btn = document.getElementById( 'generateBtn' );
                const btnIcon = document.getElementById( 'btnIcon' );
                const btnText = document.getElementById( 'btnText' );
                const consoleOut = document.getElementById( 'consoleOutput' );

                // Loading state
                btn.disabled = true;
                btnIcon.innerHTML = '‚è≥';
                btnIcon.classList.add( 'spin' );
                btnText.textContent = 'Gerando...';
                showStatus( 'loading', 'üéôÔ∏è Processando √°udio (Speed +20% | Mastering)...' );

                // Clear console
                consoleOut.innerHTML = '<span style="color: #60a5fa;">> Iniciando pipeline de voz...</span>';

                // Log Polling Loop
                let isFinished = false;
                let lastLogIndex = 0;

                // Start polling logs immediately
                const logPoller = setInterval( async () =>
                {
                    if ( isFinished )
                    {
                        clearInterval( logPoller );
                        return;
                    }
                    try
                    {
                        const res = await fetch( '/api/logs' );
                        const data = await res.json();
                        if ( data.logs && data.logs.length > lastLogIndex )
                        {
                            const newLogs = data.logs.slice( lastLogIndex );
                            newLogs.forEach( log =>
                            {
                                const line = document.createElement( 'div' );
                                line.textContent = '> ' + log;
                                if ( log.includes( '‚úÖ' ) ) line.style.color = '#4ade80';
                                else if ( log.includes( '‚ùå' ) || log.includes( 'Erro' ) ) line.style.color = '#ef4444';
                                else if ( log.includes( 'üîß' ) ) line.style.color = '#fbbf24';
                                else line.style.color = '#e2e8f0';
                                consoleOut.appendChild( line );
                            } );
                            lastLogIndex = data.logs.length;
                            consoleOut.scrollTop = consoleOut.scrollHeight;
                        }
                    } catch ( e ) { }
                }, 500 );

                try
                {
                    const response = await fetch( '/api/voice/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify( { text } )
                    } );

                    const result = await response.json();

                    isFinished = true; // Stop logger

                    if ( result.status === 'success' )
                    {
                        showStatus( 'success', '‚úÖ √Åudio gerado com sucesso!' );
                        consoleOut.innerHTML += '<br><span style="color: #4ade80;">> [DONE] √Åudio pronto!</span>';

                        const audioPlayer = document.getElementById( 'audioPlayer' );
                        const audioOutput = document.getElementById( 'audioOutput' );

                        audioOutput.src = result.audio_url + '?t=' + Date.now();
                        audioPlayer.classList.add( 'visible' );
                        audioOutput.play();

                        addToHistory( text, result.audio_url );

                    } else
                    {
                        showStatus( 'error', '‚ùå ' + ( result.message || 'Erro ao gerar √°udio' ) );
                        consoleOut.innerHTML += `<br><span style="color: #ef4444;">> ERRO: ${ result.message }</span>`;
                    }

                } catch ( err )
                {
                    isFinished = true;
                    showStatus( 'error', '‚ùå Erro de conex√£o: ' + err.message );
                } finally
                {
                    btn.disabled = false;
                    btnIcon.innerHTML = 'üé§';
                    btnIcon.classList.remove( 'spin' );
                    btnText.textContent = 'Gerar √Åudio';
                }
            }

            function showStatus ( type, message )
            {
                const status = document.getElementById( 'status' );
                status.className = 'status ' + type;
                status.textContent = message;
            }

            function addToHistory ( text, url )
            {
                history.unshift( { text, url, time: Date.now() } );

                // Keep only last 5
                if ( history.length > 5 ) history.pop();

                updateHistoryUI();
            }

            function updateHistoryUI ()
            {
                const container = document.getElementById( 'history' );

                if ( history.length === 0 )
                {
                    container.innerHTML = '<p style="color: #64748b; text-align: center;">Nenhum √°udio gerado ainda</p>';
                    return;
                }

                container.innerHTML = history.map( ( item, i ) => `
                <div class="history-item">
                    <div class="text">${ item.text }</div>
                    <audio src="${ item.url }?t=${ item.time }" controls></audio>
                </div>
            `).join( '' );
            }

            // Check voice status on load
            async function checkVoiceStatus ()
            {
                try
                {
                    const response = await fetch( '/api/voice/model' );
                    const result = await response.json();

                    const statusEl = document.getElementById( 'voiceStatus' );

                    if ( result.status === 'success' )
                    {
                        statusEl.innerHTML = `
                        <div class="dot"></div>
                        <span>‚úÖ Voz personalizada: ${ result.model.samples?.length || 0 } amostras</span>
                    `;
                    } else
                    {
                        statusEl.innerHTML = `
                        <div class="dot" style="background: #f59e0b;"></div>
                        <span>‚ö†Ô∏è Usando voz padr√£o (Edge TTS)</span>
                    `;
                    }
                } catch ( err )
                {
                    console.error( 'Error checking voice status:', err );
                }
            }

            checkVoiceStatus();
        </script>
    </body>

</html>
