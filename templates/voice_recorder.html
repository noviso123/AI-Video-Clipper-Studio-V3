<!DOCTYPE html>
<html lang="pt-BR">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>üéôÔ∏è Gravador de Voz - Crie seu Modelo</title>
        <style>
            * {
                font-family: 'Segoe UI', system-ui, sans-serif;
                box-sizing: border-box;
            }

            body {
                background: linear-gradient(135deg, #0a0a1a 0%, #1a1030 50%, #0a0a1a 100%);
                min-height: 100vh;
                margin: 0;
                padding: 20px;
                color: white;
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
            }

            h1 {
                text-align: center;
                background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                font-size: 2rem;
                margin-bottom: 10px;
            }

            .subtitle {
                text-align: center;
                color: #94a3b8;
                margin-bottom: 30px;
            }

            .card {
                background: rgba(20, 20, 40, 0.8);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 20px;
            }

            .card h2 {
                margin-top: 0;
                color: #a78bfa;
                font-size: 1.2rem;
            }

            .script-box {
                background: #1a1a2e;
                border: 2px dashed #3b82f6;
                border-radius: 12px;
                padding: 20px;
                font-size: 1.1rem;
                line-height: 1.8;
                color: #e2e8f0;
                margin: 15px 0;
            }

            .btn {
                padding: 14px 28px;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-record {
                background: linear-gradient(135deg, #dc2626, #f43f5e);
                color: white;
            }

            .btn-record:hover {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
            }

            .btn-record.recording {
                animation: pulse 1s infinite;
            }

            .btn-stop {
                background: linear-gradient(135deg, #374151, #4b5563);
                color: white;
            }

            .btn-save {
                background: linear-gradient(135deg, #059669, #10b981);
                color: white;
            }

            .btn-next {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                color: white;
            }

            @keyframes pulse {

                0%,
                100% {
                    box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5);
                }

                50% {
                    box-shadow: 0 0 30px 10px rgba(220, 38, 38, 0.3);
                }
            }

            .controls {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                margin: 20px 0;
            }

            .progress-bar {
                height: 6px;
                background: #1e293b;
                border-radius: 3px;
                overflow: hidden;
                margin: 20px 0;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                width: 0%;
                transition: width 0.3s ease;
            }

            .recordings-list {
                display: grid;
                gap: 12px;
                margin-top: 15px;
            }

            .recording-item {
                background: #1e1e3a;
                padding: 12px 16px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .recording-item .info {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .recording-item .status {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #10b981;
            }

            .recording-item audio {
                height: 32px;
            }

            .recording-item .delete-btn {
                background: none;
                border: none;
                color: #ef4444;
                cursor: pointer;
                font-size: 1.2rem;
            }

            .visualizer {
                height: 80px;
                background: #0d0d1a;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 3px;
                overflow: hidden;
            }

            .bar {
                width: 4px;
                background: linear-gradient(to top, #3b82f6, #8b5cf6);
                border-radius: 2px;
                animation: none;
            }

            .bar.active {
                animation: wave 0.5s ease infinite;
            }

            @keyframes wave {

                0%,
                100% {
                    height: 10px;
                }

                50% {
                    height: 60px;
                }
            }

            .step-indicator {
                display: flex;
                justify-content: center;
                gap: 8px;
                margin-bottom: 30px;
            }

            .step {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #1e293b;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            .step.active {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            }

            .step.done {
                background: #10b981;
            }

            .timer {
                font-size: 2rem;
                font-weight: bold;
                text-align: center;
                color: #f43f5e;
                font-family: monospace;
            }

            .hidden {
                display: none !important;
            }

            .info-box {
                background: rgba(59, 130, 246, 0.1);
                border-left: 4px solid #3b82f6;
                padding: 12px 16px;
                border-radius: 0 8px 8px 0;
                margin: 15px 0;
                font-size: 0.9rem;
                color: #94a3b8;
            }

            .success-box {
                background: rgba(16, 185, 129, 0.1);
                border-left: 4px solid #10b981;
                padding: 12px 16px;
                border-radius: 0 8px 8px 0;
                color: #10b981;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>üéôÔ∏è Gravador de Voz Personalizada</h1>
            <p class="subtitle">Grave sua voz para criar um modelo exclusivo de narra√ß√£o</p>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
                <div class="step" id="step4">4</div>
                <div class="step" id="step5">5</div>
            </div>

            <!-- Progress -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <h2>üìã Instru√ß√µes</h2>
                <p>Para criar um modelo de voz de alta qualidade, voc√™ precisa gravar <strong>5 frases</strong>
                    diferentes. Leia cada frase em voz alta, de forma clara e natural.</p>
                <div class="info-box">
                    üí° <strong>Dicas:</strong> Fale em um ambiente silencioso, mantenha o microfone a ~20cm da boca, e
                    fale no seu tom natural de voz.
                </div>
            </div>

            <!-- Script Card -->
            <div class="card">
                <h2>üìù Frase <span id="currentPhrase">1</span> de 5</h2>
                <div class="script-box" id="scriptText">
                    A intelig√™ncia artificial est√° transformando a forma como criamos conte√∫do para as redes sociais. √â
                    incr√≠vel ver como a tecnologia pode nos ajudar a ser mais criativos e produtivos.
                </div>

                <!-- Visualizer -->
                <div class="visualizer" id="visualizer">
                    <div class="bar" style="animation-delay: 0.0s;"></div>
                    <div class="bar" style="animation-delay: 0.1s;"></div>
                    <div class="bar" style="animation-delay: 0.2s;"></div>
                    <div class="bar" style="animation-delay: 0.3s;"></div>
                    <div class="bar" style="animation-delay: 0.4s;"></div>
                    <div class="bar" style="animation-delay: 0.5s;"></div>
                    <div class="bar" style="animation-delay: 0.6s;"></div>
                    <div class="bar" style="animation-delay: 0.7s;"></div>
                    <div class="bar" style="animation-delay: 0.8s;"></div>
                    <div class="bar" style="animation-delay: 0.9s;"></div>
                    <div class="bar" style="animation-delay: 1.0s;"></div>
                    <div class="bar" style="animation-delay: 1.1s;"></div>
                    <div class="bar" style="animation-delay: 1.2s;"></div>
                    <div class="bar" style="animation-delay: 1.3s;"></div>
                    <div class="bar" style="animation-delay: 1.4s;"></div>
                    <div class="bar" style="animation-delay: 0.0s;"></div>
                    <div class="bar" style="animation-delay: 0.1s;"></div>
                    <div class="bar" style="animation-delay: 0.2s;"></div>
                    <div class="bar" style="animation-delay: 0.3s;"></div>
                    <div class="bar" style="animation-delay: 0.4s;"></div>
                </div>

                <!-- Timer -->
                <div class="timer hidden" id="timer">00:00</div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn btn-record" id="recordBtn" onclick="toggleRecording()">
                        <span>üî¥</span> Gravar
                    </button>
                    <button class="btn btn-stop hidden" id="stopBtn" onclick="stopRecording()">
                        <span>‚èπÔ∏è</span> Parar
                    </button>
                </div>

                <!-- Audio Preview -->
                <div id="previewContainer" class="hidden">
                    <h3 style="margin: 15px 0 10px;">üîä Pr√©via:</h3>
                    <audio id="audioPreview" controls style="width: 100%;"></audio>
                    <div class="controls">
                        <button class="btn btn-record" onclick="reRecord()">
                            <span>üîÑ</span> Regravar
                        </button>
                        <button class="btn btn-save" onclick="saveAndNext()">
                            <span>‚úÖ</span> Salvar e Pr√≥xima
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Recordings -->
            <div class="card">
                <h2>üíæ Grava√ß√µes Salvas (<span id="savedCount">0</span>/5)</h2>
                <div class="recordings-list" id="recordingsList">
                    <p style="color: #64748b; text-align: center;">Nenhuma grava√ß√£o ainda</p>
                </div>
            </div>

            <!-- Console/Logs -->
            <div class="card hidden" id="consoleCard">
                <h2>üñ•Ô∏è Processamento do Modelo</h2>
                <div class="script-box" id="consoleOutput"
                    style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; background: #000;">
                    <span style="color: #4ade80;">> Sistema pronto...</span>
                </div>
                <div class="controls" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-next hidden" id="finishBtn" onclick="window.location.href='/'">
                        <span>üè†</span> Voltar ao In√≠cio
                    </button>
                    <button class="btn btn-record hidden" id="testBtn" onclick="window.location.href='/voice-test'">
                        <span>üó£Ô∏è</span> Testar Voz Agora
                    </button>
                </div>
            </div>

            <!-- Final Actions -->
            <div class="card hidden" id="finalCard">
                <div class="success-box">
                    <h2 style="margin: 0;">‚úÖ Todas as grava√ß√µes conclu√≠das!</h2>
                    <p>Suas amostras de voz foram salvas. Agora podemos processar e criar seu modelo.</p>
                </div>
                <div class="controls" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-next" onclick="createVoiceModel()">
                        <span>üöÄ</span> Criar Modelo de Voz
                    </button>
                </div>
            </div>

            <!-- Back Link -->
            <p style="text-align: center; margin-top: 30px;">
                <a href="/" style="color: #60a5fa; text-decoration: none;">‚Üê Voltar para o AI Video Clipper</a>
            </p>
        </div>

        <script>
            // Scripts para grava√ß√£o
            const scripts = [
                "A intelig√™ncia artificial est√° transformando a forma como criamos conte√∫do para as redes sociais. √â incr√≠vel ver como a tecnologia pode nos ajudar a ser mais criativos e produtivos.",
                "Ol√°, meu nome √© um criador de conte√∫do digital. Eu uso ferramentas de automa√ß√£o para produzir v√≠deos de alta qualidade de forma r√°pida e eficiente.",
                "Neste v√≠deo vou compartilhar com voc√™s tr√™s dicas essenciais que v√£o mudar completamente a forma como voc√™ trabalha com edi√ß√£o de v√≠deo.",
                "Muitas pessoas n√£o sabem, mas existe uma t√©cnica simples que pode dobrar o engajamento dos seus v√≠deos. Vou revelar esse segredo agora.",
                "Obrigado por assistir at√© o final! Se voc√™ gostou desse conte√∫do, deixe seu like e se inscreva no canal para mais v√≠deos como esse."
            ];

            let currentScript = 0;
            let mediaRecorder = null;
            let audioChunks = [];
            let recordings = [];
            let timerInterval = null;
            let startTime = null;

            // Initialize
            document.getElementById( 'scriptText' ).textContent = scripts[ 0 ];

            async function toggleRecording ()
            {
                const recordBtn = document.getElementById( 'recordBtn' );
                const stopBtn = document.getElementById( 'stopBtn' );
                const bars = document.querySelectorAll( '.bar' );
                const timer = document.getElementById( 'timer' );
                const preview = document.getElementById( 'previewContainer' );

                try
                {
                    const stream = await navigator.mediaDevices.getUserMedia( { audio: true } );
                    mediaRecorder = new MediaRecorder( stream );
                    audioChunks = [];

                    mediaRecorder.ondataavailable = ( e ) =>
                    {
                        audioChunks.push( e.data );
                    };

                    mediaRecorder.onstop = () =>
                    {
                        const blob = new Blob( audioChunks, { type: 'audio/wav' } );
                        const url = URL.createObjectURL( blob );
                        document.getElementById( 'audioPreview' ).src = url;
                        preview.classList.remove( 'hidden' );

                        // Save blob for later
                        window.currentBlob = blob;

                        // Stop visualizer
                        bars.forEach( bar => bar.classList.remove( 'active' ) );
                        timer.classList.add( 'hidden' );
                        clearInterval( timerInterval );

                        // Stop tracks
                        stream.getTracks().forEach( track => track.stop() );
                    };

                    mediaRecorder.start();

                    // UI updates
                    recordBtn.classList.add( 'hidden' );
                    stopBtn.classList.remove( 'hidden' );
                    recordBtn.classList.add( 'recording' );
                    bars.forEach( bar => bar.classList.add( 'active' ) );
                    timer.classList.remove( 'hidden' );
                    preview.classList.add( 'hidden' );

                    // Start timer
                    startTime = Date.now();
                    timerInterval = setInterval( updateTimer, 100 );

                } catch ( err )
                {
                    alert( 'Erro ao acessar microfone: ' + err.message );
                }
            }

            function stopRecording ()
            {
                if ( mediaRecorder && mediaRecorder.state === 'recording' )
                {
                    mediaRecorder.stop();
                }

                document.getElementById( 'recordBtn' ).classList.remove( 'hidden', 'recording' );
                document.getElementById( 'stopBtn' ).classList.add( 'hidden' );
            }

            function updateTimer ()
            {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor( elapsed / 1000 );
                const ms = Math.floor( ( elapsed % 1000 ) / 10 );
                document.getElementById( 'timer' ).textContent =
                    `${ String( Math.floor( seconds / 60 ) ).padStart( 2, '0' ) }:${ String( seconds % 60 ).padStart( 2, '0' ) }`;
            }

            function reRecord ()
            {
                document.getElementById( 'previewContainer' ).classList.add( 'hidden' );
                document.getElementById( 'audioPreview' ).src = '';
                window.currentBlob = null;
            }

            async function saveAndNext ()
            {
                if ( !window.currentBlob ) return;

                // Save recording
                const recording = {
                    id: currentScript + 1,
                    blob: window.currentBlob,
                    url: document.getElementById( 'audioPreview' ).src
                };
                recordings.push( recording );

                // Upload to server
                await uploadRecording( recording );

                // Update UI
                updateRecordingsList();

                // Move to next
                currentScript++;
                updateProgress();

                if ( currentScript < 5 )
                {
                    document.getElementById( 'scriptText' ).textContent = scripts[ currentScript ];
                    document.getElementById( 'currentPhrase' ).textContent = currentScript + 1;
                    document.getElementById( 'previewContainer' ).classList.add( 'hidden' );
                    window.currentBlob = null;
                } else
                {
                    // All done
                    document.getElementById( 'finalCard' ).classList.remove( 'hidden' );
                }
            }

            async function uploadRecording ( recording )
            {
                const formData = new FormData();
                formData.append( 'audio', recording.blob, `voice_sample_${ recording.id }.wav` );
                formData.append( 'sample_id', recording.id );

                try
                {
                    const response = await fetch( '/api/voice/upload', {
                        method: 'POST',
                        body: formData
                    } );

                    if ( response.ok )
                    {
                        console.log( 'Recording uploaded successfully' );
                    }
                } catch ( err )
                {
                    console.error( 'Upload error:', err );
                }
            }

            function updateRecordingsList ()
            {
                const list = document.getElementById( 'recordingsList' );
                document.getElementById( 'savedCount' ).textContent = recordings.length;

                if ( recordings.length === 0 )
                {
                    list.innerHTML = '<p style="color: #64748b; text-align: center;">Nenhuma grava√ß√£o ainda</p>';
                    return;
                }

                list.innerHTML = recordings.map( rec => `
                <div class="recording-item">
                    <div class="info">
                        <div class="status"></div>
                        <span>Frase ${ rec.id }</span>
                    </div>
                    <audio src="${ rec.url }" controls style="height: 32px;"></audio>
                    <button class="delete-btn" onclick="deleteRecording(${ rec.id })">üóëÔ∏è</button>
                </div>
            `).join( '' );
            }

            function deleteRecording ( id )
            {
                const index = recordings.findIndex( r => r.id === id );
                if ( index > -1 )
                {
                    recordings.splice( index, 1 );
                    updateRecordingsList();
                }
            }

            function updateProgress ()
            {
                const progress = ( recordings.length / 5 ) * 100;
                document.getElementById( 'progressFill' ).style.width = progress + '%';

                // Update step indicators
                for ( let i = 1; i <= 5; i++ )
                {
                    const step = document.getElementById( 'step' + i );
                    step.classList.remove( 'active', 'done' );

                    if ( i < currentScript + 1 )
                    {
                        step.classList.add( 'done' );
                    } else if ( i === currentScript + 1 )
                    {
                        step.classList.add( 'active' );
                    }
                }
            }

            async function createVoiceModel ()
            {
                // UI Setup
                document.getElementById( 'finalCard' ).classList.add( 'hidden' );
                document.getElementById( 'consoleCard' ).classList.remove( 'hidden' );
                const consoleOut = document.getElementById( 'consoleOutput' );

                consoleOut.innerHTML += '<br><span style="color: #60a5fa;">> Iniciando solicita√ß√£o...</span>';

                try
                {
                    const response = await fetch( '/api/voice/create-model', {
                        method: 'POST'
                    } );

                    const result = await response.json();

                    if ( result.status === 'pending' )
                    {
                        consoleOut.innerHTML += '<br><span style="color: #fab005;">> Processamento iniciado em background...</span>';
                        consoleOut.innerHTML += '<br><span style="color: #fab005;">> Conectando ao stream de logs...</span>';

                        // Iniciar Long Polling de Logs
                        startLogPolling();

                    } else if ( result.status === 'error' )
                    {
                        consoleOut.innerHTML += `<br><span style="color: #ef4444;">‚ùå Erro: ${ result.message }</span>`;
                        alert( 'Erro: ' + result.message );
                        document.getElementById( 'finalCard' ).classList.remove( 'hidden' ); // Restaurar
                    }

                } catch ( err )
                {
                    consoleOut.innerHTML += `<br><span style="color: #ef4444;">‚ùå Erro de conex√£o: ${ err.message }</span>`;
                }
            }

            let lastLogIndex = 0;

            async function startLogPolling ()
            {
                const consoleOut = document.getElementById( 'consoleOutput' );
                let isFinished = false;

                const poller = setInterval( async () =>
                {
                    if ( isFinished )
                    {
                        clearInterval( poller );
                        return;
                    }

                    try
                    {
                        const response = await fetch( '/api/logs' );
                        const data = await response.json();

                        // Apenas novos logs
                        if ( data.logs && data.logs.length > lastLogIndex )
                        {
                            const newLogs = data.logs.slice( lastLogIndex );

                            newLogs.forEach( log =>
                            {
                                const line = document.createElement( 'div' );
                                line.textContent = '> ' + log;
                                // Colora√ß√£o b√°sica
                                if ( log.includes( '‚úÖ' ) ) line.style.color = '#4ade80';
                                else if ( log.includes( '‚ùå' ) || log.includes( 'Erro' ) ) line.style.color = '#ef4444';
                                else if ( log.includes( 'STAGE' ) ) line.style.color = '#a78bfa';
                                else if ( log.includes( 'Warning' ) ) line.style.color = '#fbbf24';
                                else line.style.color = '#e2e8f0';

                                consoleOut.appendChild( line );
                            } );

                            lastLogIndex = data.logs.length;
                            consoleOut.scrollTop = consoleOut.scrollHeight;
                        }

                        if ( data.status === 'done' )
                        {
                            isFinished = true;
                            document.getElementById( 'finishBtn' ).classList.remove( 'hidden' );
                            document.getElementById( 'testBtn' ).classList.remove( 'hidden' );
                            consoleOut.innerHTML += '<br><span style="color: #4ade80; font-weight: bold;">‚ú® PROCESSO CONCLU√çDO COM SUCESSO!</span>';
                        } else if ( data.status === 'error' )
                        {
                            isFinished = true;
                            consoleOut.innerHTML += '<br><span style="color: #ef4444; font-weight: bold;">‚ùå PROCESSO FALHOU. TENTE NOVAMENTE.</span>';
                        }

                    } catch ( e )
                    {
                        console.error( "Log error:", e );
                    }
                }, 1000 ); // Poll a cada 1s
            }
        </script>
    </body>

</html>
