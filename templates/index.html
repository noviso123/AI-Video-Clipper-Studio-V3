<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Clipper Studio V3</title>
    <style>
        /* ===== RESET & BASE ===== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 50%, #16213e 100%);
            color: #e2e8f0;
        }

        body {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        header {
            height: 50px;
            background: rgba(15, 20, 35, 0.95);
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }

        .logo-text span {
            color: #818cf8;
        }

        .status-badge {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #4ade80;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        /* ===== MAIN LAYOUT ===== */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            min-height: 0;
            overflow: hidden;
        }

        /* ===== PANELS ===== */
        .panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: rgba(15, 20, 35, 0.6);
        }

        .panel-left {
            border-right: 1px solid #334155;
        }

        .panel-center {
            background: #000;
        }

        .panel-right {
            border-left: 1px solid #334155;
        }

        .panel-header {
            height: 40px;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            min-height: 0;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            color: #e2e8f0;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.2);
        }

        .form-input::placeholder {
            color: #64748b;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab.active {
            background: #818cf8;
            color: #fff;
        }

        .tab:hover:not(.active) {
            color: #fff;
        }

        /* ===== SETTINGS GRID ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .setting-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .setting-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .setting-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #818cf8;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
        }

        .setting-input:focus {
            outline: none;
        }

        /* ===== CHECKBOXES ===== */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #94a3b8;
            cursor: pointer;
        }

        .checkbox-label:hover {
            color: #fff;
        }

        .checkbox-label input {
            accent-color: #818cf8;
        }

        /* ===== BUTTONS ===== */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
        }

        .btn-danger.pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #334155;
            color: #94a3b8;
        }

        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.5);
            color: #fff;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 11px;
        }

        /* ===== BUTTON GRID ===== */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        /* ===== PROGRESS ===== */
        .progress-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
        }

        .progress-value {
            font-size: 11px;
            color: #818cf8;
            font-weight: 700;
        }

        .progress-bar {
            height: 6px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-step {
            font-size: 10px;
            color: #64748b;
            margin-top: 8px;
            font-family: 'Consolas', monospace;
        }

        /* ===== CONSOLE ===== */
        #console {
            flex: 1;
            background: #050505;
            padding: 12px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: #4ade80;
            overflow-y: auto;
            min-height: 0;
        }

        #console div {
            margin-bottom: 2px;
        }

        .console-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .console-status .dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* ===== CLIPS GALLERY ===== */
        .chips-count {
            background: #6366f1;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }

        .clip-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .clip-card:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
        }

        .clip-thumb {
            height: 80px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .clip-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .clip-thumb .placeholder {
            font-size: 28px;
            opacity: 0.3;
        }

        .clip-number {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }

        .clip-info {
            padding: 10px;
        }

        .clip-title {
            font-size: 12px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .clip-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .clip-score {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }

        .clip-btns {
            display: flex;
            gap: 6px;
        }

        .clip-btn {
            background: rgba(99, 102, 241, 0.2);
            border: none;
            color: #818cf8;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .clip-btn:hover {
            background: #6366f1;
            color: #fff;
        }

        .clip-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .clip-btn.delete:hover {
            background: #ef4444;
            color: #fff;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
            font-size: 12px;
        }

        .empty-state .icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* ===== FOOTER ACTIONS ===== */
        .panel-footer {
            padding: 12px;
            background: rgba(15, 20, 35, 0.95);
            border-top: 1px solid #334155;
            flex-shrink: 0;
        }

        /* ===== HIDDEN ===== */
        .hidden {
            display: none !important;
        }

        /* ===== INPUT WITH BUTTON ===== */
        .input-group {
            position: relative;
        }

        .input-group .form-input {
            padding-right: 80px;
        }

        .input-group .input-btn {
            position: absolute;
            right: 4px;
            top: 4px;
            bottom: 4px;
            padding: 0 12px;
            background: #475569;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .input-group .input-btn:hover {
            background: #64748b;
        }
    </style>
</head>

<body>

    <!-- ===== HEADER ===== -->
    <header>
        <div class="logo">
            <span class="logo-icon">üé¨</span>
            <span class="logo-text">Clipper <span>Studio V3</span></span>
        </div>
        <span class="status-badge">‚ö° MODO OFFLINE</span>
    </header>

    <!-- ===== MAIN CONTENT ===== -->
    <main>

        <!-- LEFT PANEL: CONTROLS -->
        <section class="panel panel-left">
            <div class="panel-header">
                <span class="panel-title">‚öôÔ∏è Configura√ß√µes</span>
            </div>
            <div class="panel-body">

                <!-- Mode Tabs -->
                <div class="tabs">
                    <button class="tab active" id="tab-url" onclick="setMode('url')">üîó URL</button>
                    <button class="tab" id="tab-file" onclick="setMode('file')">üìÅ Arquivo</button>
                </div>

                <!-- Input -->
                <div class="form-group">
                    <label class="form-label">Origem do V√≠deo</label>
                    <div class="input-group">
                        <input type="text" id="input-val" class="form-input"
                            placeholder="Cole a URL do YouTube aqui...">
                        <input type="file" id="file-input" class="hidden" accept="video/*"
                            onchange="handleFileUpload(event)">
                        <button id="browse-btn" class="input-btn hidden" onclick="triggerBrowse()">üìÇ
                            Selecionar</button>
                    </div>
                </div>

                <!-- Settings -->
                <div class="settings-grid">
                    <div class="setting-box">
                        <div class="setting-label">Clips</div>
                        <input type="number" id="input-clips" class="setting-input" value="3">
                    </div>
                    <div class="setting-box">
                        <div class="setting-label">Min (s)</div>
                        <input type="number" id="input-min-dur" class="setting-input" value="60">
                    </div>
                    <div class="setting-box">
                        <div class="setting-label">Max (s)</div>
                        <input type="number" id="input-max-dur" class="setting-input" value="90">
                    </div>
                </div>

                <!-- Options -->
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="check-captions" checked> Legendas Autom√°ticas
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="check-critic" checked> Cr√≠tico de IA
                    </label>
                </div>

                <!-- Progress -->
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-label">Progresso</span>
                        <span class="progress-value" id="progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar"></div>
                    </div>
                    <div class="progress-step" id="process-step">Aguardando in√≠cio...</div>
                </div>

                <!-- Main Action Buttons -->
                <button id="start-btn" class="btn btn-primary" onclick="startProcessing()">
                    üöÄ GERAR CLIPS
                </button>
                <button id="stop-btn" class="btn btn-danger pulse hidden" onclick="stopProcessing()">
                    üõë PARAR PROCESSAMENTO
                </button>

            </div>

            <!-- Footer Actions -->
            <div class="panel-footer">
                <div class="btn-grid">
                    <button class="btn btn-secondary btn-sm" onclick="refreshPage()">üîÑ Atualizar</button>
                    <button class="btn btn-secondary btn-sm" onclick="nukeAll()" style="color: #f87171;">‚ò¢Ô∏è Reset
                        Total</button>
                </div>
                <button class="btn btn-secondary btn-sm" style="margin-top: 8px;" onclick="deleteAllClips()">üóëÔ∏è
                    Excluir Todos os Clips</button>
            </div>
        </section>

        <!-- CENTER PANEL: CONSOLE -->
        <section class="panel panel-center">
            <div class="panel-header">
                <span class="panel-title">Terminal (Live)</span>
                <div class="console-status">
                    <span class="dot"></span>
                    <span style="font-size: 10px; color: #4ade80;">Conectado</span>
                </div>
            </div>
            <div id="console">
                <div style="color: #64748b;">$ Sistema inicializado. Aguardando comando...</div>
            </div>
        </section>

        <!-- RIGHT PANEL: GALLERY -->
        <section class="panel panel-right">
            <div class="panel-header">
                <span class="panel-title">üìÅ Galeria de Clips</span>
                <span class="chips-count" id="clips-count">0</span>
            </div>
            <div class="panel-body" id="clips-list">
                <div class="empty-state">
                    <div class="icon">üé¨</div>
                    <div>Nenhum clip gerado ainda.</div>
                    <div style="margin-top: 5px; font-size: 10px;">Inicie um processamento para criar clips.</div>
                </div>
            </div>
        </section>

    </main>

    <!-- ===== SCRIPTS ===== -->
    <script>
        let mode = 'url';
        let eventSource = null;
        let progress = 0;

        // === PROGRESS ===
        function updateProgress(val) {
            progress = val;
            document.getElementById('progress-bar').style.width = val + '%';
            document.getElementById('progress-text').innerText = val + '%';
        }

        // === MODE SWITCH ===
        function setMode(m) {
            mode = m;
            document.getElementById('tab-url').className = m === 'url' ? 'tab active' : 'tab';
            document.getElementById('tab-file').className = m === 'file' ? 'tab active' : 'tab';

            const input = document.getElementById('input-val');
            const browse = document.getElementById('browse-btn');

            if (m === 'url') {
                input.placeholder = 'Cole a URL do YouTube aqui...';
                browse.classList.add('hidden');
            } else {
                input.placeholder = 'Caminho do arquivo local...';
                browse.classList.remove('hidden');
            }
        }

        // === PROCESSING ===
        async function startProcessing() {
            const input = document.getElementById('input-val').value.trim();
            if (!input) return alert('‚ö†Ô∏è Digite uma URL ou selecione um arquivo!');

            setRunningUI(true);
            updateProgress(5);
            document.getElementById('process-step').innerText = 'üîÑ Iniciando processamento...';

            try {
                await fetch('/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode, input,
                        clips: parseInt(document.getElementById('input-clips').value) || 3,
                        min_duration: parseInt(document.getElementById('input-min-dur').value) || 60,
                        max_duration: parseInt(document.getElementById('input-max-dur').value) || 90,
                        captions: document.getElementById('check-captions').checked,
                        critic: document.getElementById('check-critic').checked
                    })
                });
            } catch (e) {
                alert('‚ùå Erro de conex√£o com o servidor!');
                setRunningUI(false);
            }
        }

        async function stopProcessing() {
            if (confirm('‚ö†Ô∏è Deseja realmente parar o processamento?')) {
                await fetch('/api/stop', { method: 'POST' });
                setTimeout(refreshPage, 500);
            }
        }

        function setRunningUI(isActive) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const step = document.getElementById('process-step');

            if (isActive) {
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                step.style.color = '#818cf8';
            } else {
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                step.innerText = '‚úÖ Pronto';
                step.style.color = '#64748b';
                updateProgress(0);
            }
        }

        // === LIVE STREAM ===
        function connectStream() {
            if (eventSource) eventSource.close();
            const skip = document.querySelectorAll('#console div').length;
            eventSource = new EventSource('/stream?skip=' + skip);
            const term = document.getElementById('console');

            eventSource.onmessage = e => {
                const msg = e.data.replace('data: ', '');
                const line = document.createElement('div');
                line.textContent = msg;
                term.appendChild(line);
                term.scrollTop = term.scrollHeight;

                // Progress Heuristics
                const step = document.getElementById('process-step');

                // Parse download progress from yt-dlp
                const downloadMatch = msg.match(/\[download\]\s+([\d.]+)%/);
                if (downloadMatch) {
                    const dlPercent = parseFloat(downloadMatch[1]);
                    const mappedProgress = 10 + (dlPercent / 100) * 15; // Map 0-100% to 10-25%
                    updateProgress(Math.round(mappedProgress));
                    step.innerText = `üì• Baixando v√≠deo... ${dlPercent.toFixed(1)}%`;
                }

                if (msg.includes('STAGE 1')) { updateProgress(10); step.innerText = 'üì• Baixando v√≠deo...'; }
                if (msg.includes('STAGE 2')) { updateProgress(25); step.innerText = 'üéôÔ∏è Transcrevendo √°udio...'; }
                if (msg.includes('Transcrevendo')) { updateProgress(35); }
                if (msg.includes('STAGE 3')) { updateProgress(50); step.innerText = 'üß† Analisando com IA...'; }
                if (msg.includes('STAGE 4')) { updateProgress(65); step.innerText = '‚úÇÔ∏è Cortando clips...'; }
                if (msg.includes('render_clip') || msg.includes('Renderizando')) {
                    if (progress < 90) updateProgress(progress + 5);
                }
                if (msg.includes('STAGE 5') || msg.includes('STAGE 6')) { updateProgress(95); step.innerText = 'üöÄ Finalizando...'; }

                if (msg.includes('[PROCESS FINISHED]')) {
                    updateProgress(100);
                    step.innerText = msg.includes('Sucesso') ? '‚úÖ Conclu√≠do com sucesso!' : '‚ö†Ô∏è Finalizado com avisos';
                    setTimeout(() => {
                        setRunningUI(false);
                        loadClips();
                    }, 1500);
                }
            };

            eventSource.onerror = () => {
                eventSource.close();
                setTimeout(connectStream, 2000);
            };
        }

        // === CLIPS GALLERY ===
        async function loadClips() {
            try {
                const res = await fetch('/api/clips');
                const data = await res.json();
                document.getElementById('clips-count').innerText = data.length;
                const list = document.getElementById('clips-list');

                if (!data.length) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üé¨</div>
                            <div>Nenhum clip gerado ainda.</div>
                            <div style="margin-top: 5px; font-size: 10px;">Inicie um processamento para criar clips.</div>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = data.map((c, i) => `
                    <div class="clip-card">
                        <div class="clip-thumb">
                            ${c.thumb ? `<img src="/exports/${c.thumb}" alt="Thumbnail">` : '<span class="placeholder">üé¨</span>'}
                            <span class="clip-number">#${i + 1}</span>
                        </div>
                        <div class="clip-info">
                            <div class="clip-title" title="${c.title || 'Clip'}">${c.title || 'Clip ' + (i + 1)}</div>
                            <div class="clip-actions">
                                <span class="clip-score">‚≠ê ${(c.score || 0).toFixed(1)}</span>
                                <div class="clip-btns">
                                    <a href="/exports/${c.video}" download class="clip-btn">‚¨áÔ∏è Baixar</a>
                                    <button class="clip-btn delete" onclick="deleteClip('${c.video}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error('Erro ao carregar clips:', e); }
        }

        // === DELETE CLIP ===
        async function deleteClip(filename) {
            if (!confirm(`üóëÔ∏è Excluir ${filename}?`)) return;
            try {
                await fetch(`/api/exports/delete/${filename}`, { method: 'DELETE' });
                loadClips();
            } catch (e) { alert('‚ùå Erro ao excluir'); }
        }

        // === RESTORE STATE ===
        async function restoreState() {
            try {
                const res = await fetch('/status');
                const s = await res.json();

                if (s.running) {
                    setRunningUI(true);
                    document.getElementById('input-val').value = s.current_project?.input || '';
                    if (s.current_project?.mode === 'file') setMode('file');
                }

                if (s.logs && s.logs.length) {
                    const term = document.getElementById('console');
                    term.innerHTML = s.logs.map(l => `<div>${l}</div>`).join('');
                    term.scrollTop = term.scrollHeight;

                    // === RESTORE PROGRESS FROM LOGS ===
                    let restoredProgress = 0;
                    let lastStep = 'Aguardando...';
                    const step = document.getElementById('process-step');

                    for (const log of s.logs) {
                        // Parse download progress from yt-dlp logs
                        const downloadMatch = log.match(/\[download\]\s+([\d.]+)%/);
                        if (downloadMatch) {
                            const dlPercent = parseFloat(downloadMatch[1]);
                            const mappedProgress = 10 + (dlPercent / 100) * 15; // Map 0-100% to 10-25%
                            restoredProgress = Math.max(restoredProgress, Math.round(mappedProgress));
                            lastStep = `üì• Baixando v√≠deo... ${dlPercent.toFixed(1)}%`;
                        }

                        if (log.includes('STAGE 1')) { restoredProgress = 10; lastStep = 'üì• Baixando v√≠deo...'; }
                        if (log.includes('STAGE 2')) { restoredProgress = 25; lastStep = 'üéôÔ∏è Transcrevendo √°udio...'; }
                        if (log.includes('Transcrevendo')) { restoredProgress = Math.max(restoredProgress, 35); }
                        if (log.includes('STAGE 3')) { restoredProgress = 50; lastStep = 'üß† Analisando com IA...'; }
                        if (log.includes('STAGE 4')) { restoredProgress = 65; lastStep = '‚úÇÔ∏è Cortando clips...'; }
                        if (log.includes('render_clip') || log.includes('Renderizando')) {
                            restoredProgress = Math.min(restoredProgress + 5, 90);
                        }
                        if (log.includes('STAGE 5') || log.includes('STAGE 6')) { restoredProgress = 95; lastStep = 'üöÄ Finalizando...'; }
                        if (log.includes('[PROCESS FINISHED]')) {
                            restoredProgress = 100;
                            lastStep = log.includes('Sucesso') ? '‚úÖ Conclu√≠do!' : '‚ö†Ô∏è Finalizado';
                        }
                    }

                    // Apply restored progress
                    if (restoredProgress > 0) {
                        updateProgress(restoredProgress);
                        step.innerText = lastStep;
                        if (s.running) step.style.color = '#818cf8';
                    }
                }
            } catch (e) { }
        }

        // === UPLOAD / BROWSE ===
        function triggerBrowse() {
            document.getElementById('file-input').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const step = document.getElementById('process-step');
            const startBtn = document.getElementById('start-btn');

            setRunningUI(true);
            startBtn.classList.add('hidden'); // Ensure start is hidden during upload
            step.innerText = 'üì§ Enviando arquivo: ' + file.name;
            step.style.color = '#fbbf24';

            const formData = new FormData();
            formData.append('video', file);

            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    updateProgress(percent);
                }
            });

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        const res = JSON.parse(xhr.responseText);
                        document.getElementById('input-val').value = res.path;
                        step.innerText = '‚úÖ Upload conclu√≠do! Pronto para gerar clips.';
                        step.style.color = '#4ade80';
                        updateProgress(100);
                        setTimeout(() => { setRunningUI(false); updateProgress(0); }, 2000);
                    } else {
                        alert('‚ùå Erro no upload: ' + xhr.statusText);
                        setRunningUI(false);
                    }
                }
            };

            xhr.open('POST', '/api/upload', true);
            xhr.send(formData);
        }

        async function browseFile() {
            // Fallback para quando o sistema √© local (opcional)
            try {
                const r = await fetch('/browse');
                const d = await r.json();
                if (d.path) document.getElementById('input-val').value = d.path;
            } catch (e) { triggerBrowse(); }
        }

        async function nukeAll() {
            if (confirm('‚ò¢Ô∏è ATEN√á√ÉO: Isso vai apagar TODOS os clips, cache e logs. Continuar?')) {
                await fetch('/api/nuke', { method: 'DELETE' });
                location.reload();
            }
        }

        function refreshPage() { location.reload(); }

        async function deleteAllClips() {
            if (confirm('üóëÔ∏è Excluir TODOS os clips da galeria?')) {
                await fetch('/api/exports/delete-all', { method: 'DELETE' });
                loadClips();
            }
        }

        // === INIT ===
        window.onload = async () => {
            await restoreState();
            loadClips();
            connectStream();
        };
    </script>

</body>

</html>